<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="dark light" />
  <title>SKPP • QR & Smart Links</title>

  <!-- Styled QR -->
  <script src="https://unpkg.com/qr-code-styling@1.9.1/lib/qr-code-styling.js"></script>

  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0B1020;
      --card: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --accent:#7C3AED;
      --accent2:#22D3EE;
      --ok:#22C55E;
      --warn:#F59E0B;
      --bad:#EF4444;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Noto Sans Arabic", "Tahoma", Arial, sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:var(--sans); color:var(--text);
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(124,58,237,.35), transparent 60%),
        radial-gradient(1000px 700px at 90% 20%, rgba(34,211,238,.25), transparent 55%),
        radial-gradient(900px 600px at 40% 95%, rgba(34,197,94,.14), transparent 60%),
        linear-gradient(180deg,var(--bg0),var(--bg1));
      overflow-x:hidden;
    }
    a{color:inherit}
    .wrap{max-width:1200px;margin:0 auto;padding:28px 18px 44px}
    header{
      display:flex; gap:14px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      margin-bottom:18px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
    }
    .logo{
      width:46px;height:46px;border-radius:14px;
      background: linear-gradient(135deg,var(--accent),var(--accent2));
      box-shadow: 0 10px 30px rgba(124,58,237,.35);
      position:relative;
    }
    .logo:before{
      content:""; position:absolute; inset:10px;
      border-radius:12px; border:1px solid rgba(255,255,255,.35);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.25);
    }
    .title{
      display:flex; flex-direction:column; line-height:1.2
    }
    .title b{font-size:18px; letter-spacing:.2px}
    .title span{color:var(--muted); font-size:13px}
    .top-actions{display:flex; gap:10px; flex-wrap:wrap}
    .btn{
      border:1px solid var(--stroke); background: rgba(255,255,255,.04);
      color:var(--text); padding:10px 12px; border-radius:12px;
      box-shadow: 0 8px 24px rgba(0,0,0,.20);
      cursor:pointer; user-select:none;
      display:inline-flex; align-items:center; gap:8px;
      transition:.15s transform, .15s background, .15s border;
      font-family:var(--sans);
    }
    .btn:hover{transform:translateY(-1px); background:rgba(255,255,255,.06)}
    .btn:active{transform:translateY(0px)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(34,211,238,.70));
      border-color: rgba(255,255,255,.16);
    }
    .btn.good{background: rgba(34,197,94,.16); border-color: rgba(34,197,94,.35)}
    .btn.bad{background: rgba(239,68,68,.14); border-color: rgba(239,68,68,.35)}
    .grid{
      display:grid; gap:14px;
      grid-template-columns: 1.1fr .9fr;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr}
    }
    .card{
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .card h2{
      margin:0; padding:16px 16px 10px;
      font-size:15px; letter-spacing:.2px;
    }
    .card .sub{
      padding:0 16px 14px; color:var(--muted); font-size:13px;
    }
    .body{padding: 0 16px 16px}
    .row{display:grid; gap:10px; grid-template-columns: 1fr 1fr}
    @media (max-width: 640px){ .row{grid-template-columns:1fr} }
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    input, select, textarea{
      width:100%;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      border-radius: 12px;
      padding: 11px 12px;
      outline:none;
      font-family: var(--sans);
    }
    textarea{min-height:88px; resize:vertical}
    .hint{font-size:12px;color:var(--muted); margin-top:6px}
    .mono{font-family: var(--mono)}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      font-size:12px; color:var(--muted);
      border:1px solid rgba(255,255,255,.12);
      padding:8px 10px; border-radius:999px;
      background: rgba(0,0,0,.18);
    }
    .split{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      padding: 0 16px 16px;
    }
    .qrBox{
      padding: 16px;
      display:grid; gap:14px;
    }
    .qrStage{
      border-radius: 16px;
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.18);
      min-height: 340px;
      display:grid; place-items:center;
      padding: 14px;
      position:relative;
      overflow:hidden;
    }
    .qrStage .glow{
      position:absolute; inset:-80px;
      background: radial-gradient(circle at 30% 30%, rgba(124,58,237,.25), transparent 50%),
                  radial-gradient(circle at 70% 50%, rgba(34,211,238,.18), transparent 55%);
      filter: blur(18px);
      pointer-events:none;
    }
    .qrMount{position:relative; z-index:1}
    .status{
      padding: 12px 16px 16px;
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;
      border-top:1px solid rgba(255,255,255,.08);
      color:var(--muted);
      font-size:13px;
    }
    .status b{color:var(--text)}
    .table{
      width:100%; border-collapse:separate; border-spacing:0 10px;
    }
    .table th{
      text-align:right; font-size:12px; color:var(--muted);
      padding:0 8px 6px;
      font-weight:600;
    }
    .table td{
      padding:10px 10px;
      background: rgba(0,0,0,.22);
      border-top:1px solid rgba(255,255,255,.08);
      border-bottom:1px solid rgba(255,255,255,.08);
      font-size:13px;
      vertical-align:top;
    }
    .table td:first-child{border-right:1px solid rgba(255,255,255,.08); border-top-right-radius:12px; border-bottom-right-radius:12px}
    .table td:last-child{border-left:1px solid rgba(255,255,255,.08); border-top-left-radius:12px; border-bottom-left-radius:12px}
    .k{color:var(--muted); font-size:12px}
    .actions{display:flex; gap:8px; flex-wrap:wrap}
    .toast{
      position: fixed; bottom: 18px; left: 18px;
      background: rgba(0,0,0,.65);
      border:1px solid rgba(255,255,255,.16);
      color:var(--text);
      padding:10px 12px; border-radius:12px;
      box-shadow: 0 12px 40px rgba(0,0,0,.45);
      max-width: min(520px, calc(100% - 36px));
      opacity:0; transform: translateY(10px);
      transition: .2s;
      z-index:9999;
      backdrop-filter: blur(10px);
      font-size:13px;
    }
    .toast.show{opacity:1; transform: translateY(0)}
    .divider{height:1px;background:rgba(255,255,255,.08);margin:12px 0}
    .dangerBox{
      border:1px solid rgba(239,68,68,.35);
      background: rgba(239,68,68,.10);
      padding:12px; border-radius:12px; color:rgba(255,255,255,.86);
      font-size:13px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">
          <b>SKPP</b>
          <span>QR Generator + Smart Redirects for GitHub Pages</span>
        </div>
      </div>
      <div class="top-actions">
        <button class="btn" id="btnLoadDb">تحميل links.json</button>
        <button class="btn" id="btnExport">تصدير JSON</button>
        <button class="btn primary" id="btnSaveDb">حفظ داخل المستودع</button>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: Admin + QR controls -->
      <section class="card">
        <h2>إنشاء QR + رابط قصير</h2>
        <div class="sub">اكتب أي رابط، أنشئ QR فخم، ثم اختر Slug مثل <span class="mono">ksa</span> ليصبح الرابط: <span class="mono" id="shortBasePreview"></span></div>
        <div class="body">
          <label>الرابط الهدف (URL)</label>
          <input id="inpUrl" class="mono" placeholder="https://example.com/..." autocomplete="off" />

          <div class="row">
            <div>
              <label>الاسم المختصر (Slug)</label>
              <input id="inpSlug" class="mono" placeholder="مثال: ksa أو my-link" autocomplete="off" />
              <div class="hint">سيعمل عبر <span class="mono">r.html?s=SLUG</span> (ويمكن إضافة قواعدك أنت داخل JSON).</div>
            </div>
            <div>
              <label>توليد Slug</label>
              <button class="btn" id="btnGenSlug" style="width:100%">اقتراح سريع</button>
              <div class="hint">اقتراحات قصيرة مناسبة للـ QR.</div>
            </div>
          </div>

          <div class="row">
            <div>
              <label>حجم QR</label>
              <select id="selSize">
                <option value="280">280</option>
                <option value="320" selected>320</option>
                <option value="420">420</option>
                <option value="512">512</option>
              </select>
            </div>
            <div>
              <label>صيغة التصدير</label>
              <select id="selType">
                <option value="png" selected>PNG</option>
                <option value="svg">SVG</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>نمط النقاط</label>
              <select id="selDots">
                <option value="rounded" selected>Rounded</option>
                <option value="dots">Dots</option>
                <option value="classy">Classy</option>
                <option value="classy-rounded">Classy Rounded</option>
                <option value="square">Square</option>
                <option value="extra-rounded">Extra Rounded</option>
              </select>
            </div>
            <div>
              <label>مستوى التصحيح (Error Correction)</label>
              <select id="selEc">
                <option value="L">L</option>
                <option value="M" selected>M</option>
                <option value="Q">Q</option>
                <option value="H">H</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>لون 1 (Gradient)</label>
              <input id="inpC1" type="color" value="#7C3AED" />
            </div>
            <div>
              <label>لون 2 (Gradient)</label>
              <input id="inpC2" type="color" value="#22D3EE" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>شعار (اختياري)</label>
              <input id="inpLogo" type="file" accept="image/*" />
              <div class="hint">رفع صورة يدمجها في وسط الـ QR (مفيد للهوية).</div>
            </div>
            <div>
              <label>خلفية</label>
              <select id="selBg">
                <option value="light" selected>فاتحة (مناسبة للطباعة)</option>
                <option value="dark">داكنة (تجربة/عرض)</option>
                <option value="transparent">شفافة</option>
              </select>
            </div>
          </div>

          <div class="divider"></div>

          <div class="actions">
            <button class="btn good" id="btnAddLink">إضافة/تحديث التحويل</button>
            <button class="btn" id="btnCopyShort">نسخ الرابط المختصر</button>
            <button class="btn" id="btnCopyTarget">نسخ الرابط الهدف</button>
            <button class="btn primary" id="btnDownload">تحميل QR</button>
          </div>

          <div class="divider"></div>

          <h2 style="padding:0;margin:0 0 6px;font-size:14px">إعداد الربط بالمستودع (اختياري)</h2>
          <div class="sub" style="padding:0 0 10px">
            هذا فقط إذا أردت حفظ <span class="mono">links.json</span> مباشرة داخل GitHub من الصفحة.
          </div>

          <div class="row">
            <div>
              <label>Owner</label>
              <input id="ghOwner" class="mono" placeholder="vc-sa-sa" autocomplete="off" />
            </div>
            <div>
              <label>Repo</label>
              <input id="ghRepo" class="mono" placeholder="vc-sa-sa.github.io" autocomplete="off" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Branch</label>
              <input id="ghBranch" class="mono" value="main" autocomplete="off" />
            </div>
            <div>
              <label>Path</label>
              <input id="ghPath" class="mono" value="qr/links.json" autocomplete="off" />
            </div>
          </div>

          <label>GitHub Token (لن يتم حفظه تلقائيًا)</label>
          <input id="ghToken" class="mono" placeholder="ghp_..." autocomplete="off" />
          <div class="dangerBox" style="margin-top:10px">
            تنبيه أمني: لا تضع التوكن في صفحة عامة إذا كان بإمكان أي شخص رؤيتها. الأفضل تشغيل هذه اللوحة للاستخدام الشخصي فقط، أو حذف التوكن بعد الحفظ.
          </div>

        </div>

        <div class="status">
          <div>
            <div>وضع العمل: <b id="modeLabel">محلي</b></div>
            <div class="k">محلي = localStorage / مستودع = links.json</div>
          </div>
          <div class="pill mono" id="dbCount">links: 0</div>
        </div>
      </section>

      <!-- RIGHT: QR preview + Links table -->
      <aside class="card">
        <h2>المعاينة</h2>
        <div class="sub">QR يتحدث مباشرة عند تغيير القيم، مع رابط قصير جاهز للمشاركة.</div>

        <div class="qrBox">
          <div class="qrStage" role="img" aria-label="QR Preview">
            <div class="glow" aria-hidden="true"></div>
            <div class="qrMount" id="qrMount"></div>
          </div>

          <div class="split">
            <div class="pill mono" id="shortUrlPreview">—</div>
            <div class="actions">
              <button class="btn" id="btnOpenShort">فتح المختصر</button>
              <button class="btn" id="btnOpenTarget">فتح الهدف</button>
            </div>
          </div>

          <div class="divider"></div>

          <h2 style="padding:0;margin:0 0 8px;font-size:14px">روابطك داخل المستودع</h2>
          <div class="row">
            <div>
              <label>بحث</label>
              <input id="inpSearch" placeholder="ابحث في slug أو الرابط..." />
            </div>
            <div>
              <label>استيراد JSON محلي</label>
              <input id="inpImport" type="file" accept="application/json" />
            </div>
          </div>

          <div style="overflow:auto">
            <table class="table" aria-label="Links Table">
              <thead>
                <tr>
                  <th style="min-width:120px">Slug</th>
                  <th>Target</th>
                  <th style="min-width:220px">إجراءات</th>
                </tr>
              </thead>
              <tbody id="tbLinks"></tbody>
            </table>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
(() => {
  // ---------- helpers ----------
  const $ = (id) => document.getElementById(id);
  const toast = (msg) => {
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("show");
    clearTimeout(toast._tm);
    toast._tm = setTimeout(() => t.classList.remove("show"), 2200);
  };
  const safeUrl = (s) => {
    try {
      const u = new URL(s);
      return u.href;
    } catch { return null; }
  };
  const baseFolder = () => {
    // https://site/qr/skpp.html => https://site/qr/
    const u = new URL(location.href);
    u.hash = ""; u.search = "";
    u.pathname = u.pathname.replace(/\/[^\/]*$/, "/");
    return u.toString();
  };
  const shortBase = () => `${baseFolder()}r.html?s=`;
  $("shortBasePreview").textContent = shortBase() + "slug";

  const b64encode = (text) => {
    const bytes = new TextEncoder().encode(text);
    let bin = "";
    bytes.forEach(b => bin += String.fromCharCode(b));
    return btoa(bin);
  };

  // ---------- local DB model ----------
  const LS_KEY = "skpp.links.v1";
  let db = {};           // { slug: { url, updatedAt } }
  let remoteSha = null;  // GitHub file sha for update
  let lastLogoDataUrl = null;

  const loadLocal = () => {
    try { db = JSON.parse(localStorage.getItem(LS_KEY) || "{}"); }
    catch { db = {}; }
  };
  const saveLocal = () => {
    localStorage.setItem(LS_KEY, JSON.stringify(db, null, 2));
  };

  const dbCount = () => Object.keys(db).length;

  // ---------- QR setup ----------
  const qrMount = $("qrMount");
  const qr = new QRCodeStyling({
    width: 320,
    height: 320,
    type: "canvas",
    data: "https://vc-sa-sa.github.io/qr/",
    image: undefined,
    margin: 12,
    qrOptions: { errorCorrectionLevel: "M" },
    imageOptions: { crossOrigin: "anonymous", margin: 8 },
    dotsOptions: {
      type: "rounded",
      gradient: {
        type: "linear",
        rotation: 0.9,
        colorStops: [
          { offset: 0, color: "#7C3AED" },
          { offset: 1, color: "#22D3EE" }
        ]
      }
    },
    cornersSquareOptions: { type: "extra-rounded", color: "#A78BFA" },
    cornersDotOptions: { type: "dot", color: "#22D3EE" },
    backgroundOptions: { color: "#ffffff" }
  });

  qr.append(qrMount);

  const currentShortUrl = () => {
    const slug = ($("inpSlug").value || "").trim();
    return slug ? (shortBase() + encodeURIComponent(slug)) : "—";
  };

  const applyQr = () => {
    const target = $("inpUrl").value.trim();
    const url = safeUrl(target) || target; // allow non-URL text if needed
    const size = parseInt($("selSize").value, 10) || 320;
    const dots = $("selDots").value;
    const ec = $("selEc").value;
    const c1 = $("inpC1").value;
    const c2 = $("inpC2").value;
    const type = $("selType").value;
    const bgMode = $("selBg").value;

    let bg = "#ffffff";
    if (bgMode === "dark") bg = "#0b1020";
    if (bgMode === "transparent") bg = "rgba(0,0,0,0)";

    qr.update({
      width: size,
      height: size,
      type: "canvas",
      data: url || "https://vc-sa-sa.github.io/qr/",
      image: lastLogoDataUrl || undefined,
      qrOptions: { errorCorrectionLevel: ec },
      dotsOptions: {
        type: dots,
        gradient: {
          type: "linear",
          rotation: 0.9,
          colorStops: [
            { offset: 0, color: c1 },
            { offset: 1, color: c2 }
          ]
        }
      },
      cornersSquareOptions: { type: "extra-rounded", color: c1 },
      cornersDotOptions: { type: "dot", color: c2 },
      backgroundOptions: { color: bg }
    });

    $("shortUrlPreview").textContent = currentShortUrl();
    $("modeLabel").textContent = remoteSha ? "مستودع" : "محلي";
    $("dbCount").textContent = `links: ${dbCount()}`;
  };

  let debounceTm = null;
  const scheduleQr = () => {
    clearTimeout(debounceTm);
    debounceTm = setTimeout(applyQr, 120);
  };

  // ---------- Links table ----------
  const renderLinks = () => {
    const q = ($("inpSearch").value || "").trim().toLowerCase();
    const entries = Object.entries(db)
      .map(([slug, v]) => ({ slug, ...v }))
      .filter(x => !q || x.slug.toLowerCase().includes(q) || (x.url || "").toLowerCase().includes(q))
      .sort((a,b) => a.slug.localeCompare(b.slug));

    const tb = $("tbLinks");
    tb.innerHTML = "";

    if (!entries.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td colspan="3" style="border-radius:12px; text-align:center; color: rgba(255,255,255,.65)">
          لا توجد روابط بعد. أنشئ Slug وأضف التحويل.
        </td>
      `;
      tb.appendChild(tr);
      return;
    }

    for (const it of entries) {
      const tr = document.createElement("tr");
      const shortUrl = shortBase() + encodeURIComponent(it.slug);
      tr.innerHTML = `
        <td class="mono"><div><b style="font-weight:700">${escapeHtml(it.slug)}</b></div><div class="k">${escapeHtml(shortUrl)}</div></td>
        <td class="mono" style="word-break:break-word">${escapeHtml(it.url || "")}<div class="k">${it.updatedAt ? ("آخر تحديث: " + escapeHtml(it.updatedAt)) : ""}</div></td>
        <td>
          <div class="actions">
            <button class="btn" data-act="copy" data-val="${encodeURIComponent(shortUrl)}">نسخ المختصر</button>
            <button class="btn" data-act="edit" data-slug="${escapeAttr(it.slug)}">تعديل</button>
            <button class="btn bad" data-act="del" data-slug="${escapeAttr(it.slug)}">حذف</button>
          </div>
        </td>
      `;
      tb.appendChild(tr);
    }
  };

  const escapeHtml = (s) => String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  const escapeAttr = escapeHtml;

  // ---------- Actions ----------
  $("btnGenSlug").addEventListener("click", () => {
    const pool = "abcdefghijklmnopqrstuvwxyz0123456789";
    const n = 6;
    let s = "";
    for (let i=0;i<n;i++) s += pool[Math.floor(Math.random()*pool.length)];
    $("inpSlug").value = s;
    scheduleQr();
    toast("تم اقتراح Slug.");
  });

  $("btnAddLink").addEventListener("click", () => {
    const slug = ($("inpSlug").value || "").trim();
    const url = ($("inpUrl").value || "").trim();

    if (!slug) return toast("اكتب Slug أولاً.");
    const u = safeUrl(url);
    if (!u) return toast("الرابط الهدف غير صالح (لازم يبدأ http/https).");

    db[slug] = { url: u, updatedAt: new Date().toISOString() };
    saveLocal();
    renderLinks();
    scheduleQr();
    toast("تمت الإضافة/التحديث محليًا.");
  });

  $("btnCopyShort").addEventListener("click", async () => {
    const s = currentShortUrl();
    if (s === "—") return toast("اكتب Slug أولاً.");
    await navigator.clipboard.writeText(s);
    toast("تم نسخ الرابط المختصر.");
  });

  $("btnCopyTarget").addEventListener("click", async () => {
    const u = ($("inpUrl").value || "").trim();
    if (!u) return toast("اكتب الرابط الهدف أولاً.");
    await navigator.clipboard.writeText(u);
    toast("تم نسخ الرابط الهدف.");
  });

  $("btnOpenShort").addEventListener("click", () => {
    const s = currentShortUrl();
    if (s === "—") return toast("اكتب Slug أولاً.");
    window.open(s, "_blank", "noopener");
  });

  $("btnOpenTarget").addEventListener("click", () => {
    const u = safeUrl(($("inpUrl").value || "").trim());
    if (!u) return toast("الرابط الهدف غير صالح.");
    window.open(u, "_blank", "noopener");
  });

  $("btnDownload").addEventListener("click", async () => {
    const ext = $("selType").value;
    const slug = ($("inpSlug").value || "qr").trim() || "qr";
    try {
      await qr.download({ name: `skpp-${slug}`, extension: ext });
      toast("تم تحميل QR.");
    } catch (e) {
      toast("تعذر التحميل (جرّب نوع آخر).");
    }
  });

  // table actions
  $("tbLinks").addEventListener("click", async (ev) => {
    const btn = ev.target.closest("button");
    if (!btn) return;
    const act = btn.dataset.act;

    if (act === "copy") {
      const v = decodeURIComponent(btn.dataset.val || "");
      await navigator.clipboard.writeText(v);
      return toast("تم نسخ المختصر.");
    }

    if (act === "edit") {
      const slug = btn.dataset.slug;
      const item = db[slug];
      if (!item) return;
      $("inpSlug").value = slug;
      $("inpUrl").value = item.url || "";
      scheduleQr();
      toast("تم تحميل الرابط للتعديل.");
      return;
    }

    if (act === "del") {
      const slug = btn.dataset.slug;
      if (!confirm(`حذف "${slug}"؟`)) return;
      delete db[slug];
      saveLocal();
      renderLinks();
      scheduleQr();
      toast("تم الحذف محليًا.");
    }
  });

  // import/export local JSON
  $("btnExport").addEventListener("click", () => {
    const blob = new Blob([JSON.stringify(db, null, 2)], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "links.json";
    a.click();
    URL.revokeObjectURL(a.href);
    toast("تم تصدير JSON.");
  });

  $("inpImport").addEventListener("change", async (ev) => {
    const f = ev.target.files?.[0];
    if (!f) return;
    const text = await f.text();
    try {
      const obj = JSON.parse(text);
      if (!obj || typeof obj !== "object") throw new Error("bad");
      db = obj;
      saveLocal();
      renderLinks();
      scheduleQr();
      toast("تم الاستيراد بنجاح.");
    } catch {
      toast("ملف JSON غير صالح.");
    } finally {
      ev.target.value = "";
    }
  });

  // logo
  $("inpLogo").addEventListener("change", async (ev) => {
    const f = ev.target.files?.[0];
    if (!f) { lastLogoDataUrl = null; scheduleQr(); return; }
    const reader = new FileReader();
    reader.onload = () => { lastLogoDataUrl = reader.result; scheduleQr(); toast("تمت إضافة الشعار."); };
    reader.readAsDataURL(f);
  });

  // live update
  ["inpUrl","inpSlug","selSize","selType","selDots","selEc","inpC1","inpC2","selBg","inpSearch"]
    .forEach(id => $(id).addEventListener("input", () => {
      if (id === "inpSearch") renderLinks();
      scheduleQr();
    }));

  // ---------- Remote (GitHub) read/write ----------
  async function loadFromRepo() {
    const owner = ($("ghOwner").value || "").trim();
    const repo  = ($("ghRepo").value || "").trim();
    const branch= ($("ghBranch").value || "main").trim();
    const path  = ($("ghPath").value || "qr/links.json").trim();

    if (!owner || !repo || !path) return toast("أكمل owner/repo/path.");

    const api = `https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`;

    const res = await fetch(api, { headers: { "Accept": "application/vnd.github+json" } });
    if (!res.ok) {
      remoteSha = null;
      toast("لم يتم العثور على links.json في المستودع (أو خطأ صلاحيات).");
      return;
    }
    const data = await res.json();
    remoteSha = data.sha || null;

    const content = atob((data.content || "").replace(/\n/g,""));
    db = JSON.parse(content || "{}");

    saveLocal();
    renderLinks();
    scheduleQr();
    toast("تم تحميل links.json من المستودع.");
  }

  async function saveToRepo() {
    const owner = ($("ghOwner").value || "").trim();
    const repo  = ($("ghRepo").value || "").trim();
    const branch= ($("ghBranch").value || "main").trim();
    const path  = ($("ghPath").value || "qr/links.json").trim();
    const token = ($("ghToken").value || "").trim();

    if (!owner || !repo || !path) return toast("أكمل owner/repo/path.");
    if (!token) return toast("ضع GitHub Token للحفظ.");

    // Get sha if not loaded
    if (!remoteSha) {
      await loadFromRepo();
      // If still null, it might be a new file. That's ok (GitHub API allows create without sha).
    }

    const api = `https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}/contents/${encodeURIComponent(path)}`;
    const payload = {
      message: `SKPP update links.json (${new Date().toISOString()})`,
      content: b64encode(JSON.stringify(db, null, 2)),
      branch
    };
    if (remoteSha) payload.sha = remoteSha;

    const res = await fetch(api, {
      method: "PUT",
      headers: {
        "Accept": "application/vnd.github+json",
        "Content-Type": "application/json",
        "Authorization": `token ${token}`
      },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      const t = await res.text().catch(()=> "");
      toast("فشل الحفظ داخل GitHub. راجع الصلاحيات/المسار.");
      console.warn("GitHub save error:", t);
      return;
    }

    const out = await res.json();
    remoteSha = out?.content?.sha || out?.sha || remoteSha;
    $("ghToken").value = ""; // لا نحتفظ به
    scheduleQr();
    toast("تم حفظ links.json داخل المستودع.");
  }

  $("btnLoadDb").addEventListener("click", () => loadFromRepo());
  $("btnSaveDb").addEventListener("click", () => saveToRepo());

  // ---------- init ----------
  loadLocal();
  renderLinks();
  scheduleQr();
})();
</script>
</body>
</html>
